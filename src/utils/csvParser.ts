import * as FileSystem from "expo-file-system";
import { Skill } from "../types";

/**
 * CSVファイルからスキルデータを読み込む関数
 * @returns スキルデータの配列
 */
export const loadSkillsFromCSV = async (): Promise<Skill[]> => {
  try {
    // CSVデータを直接ハードコードする
    // 実際のアプリでは、アセットからの読み込みや、APIからの取得などを行うべきですが、
    // 開発中の問題を回避するために、ここではデータを直接埋め込みます
    const fileContent = `分野,項目,レベル,スキル
インフラエンジニア,サーバー,初級,基本構築/管理
インフラエンジニア,サーバー,初級,基本監視
インフラエンジニア,サーバー,初級,OSセットアップ
インフラエンジニア,サーバー,初級,トラブルシューティング（初級）
インフラエンジニア,サーバー,中級,高可用性設計
インフラエンジニア,サーバー,中級,パフォーマンス最適化
インフラエンジニア,サーバー,中級,サーバーリソース管理
インフラエンジニア,サーバー,中級,中級Linux操作（LPIC2相当）
インフラエンジニア,サーバー,上級,インフラ全体設計
インフラエンジニア,サーバー,上級,災害対策/BCP策定
インフラエンジニア,サーバー,上級,大規模システム設計
インフラエンジニア,サーバー,上級,オンプレミス/クラウド連携設計
インフラエンジニア,クラウド,初級,AWS/Azure/GCP基本操作
インフラエンジニア,クラウド,初級,クラウドリソース作成/削除
インフラエンジニア,クラウド,初級,基本的なサービス利用
インフラエンジニア,クラウド,初級,仮想マシン管理
インフラエンジニア,クラウド,中級,IaC（Terraform等）
インフラエンジニア,クラウド,中級,コンテナ技術（Docker/K8s）
インフラエンジニア,クラウド,中級,クラウドコスト最適化
インフラエンジニア,クラウド,中級,クラウド監視/セキュリティ対策
インフラエンジニア,クラウド,上級,マルチクラウド設計
インフラエンジニア,クラウド,上級,クラウドネイティブアーキテクチャ
インフラエンジニア,クラウド,上級,クラウド移行計画
インフラエンジニア,クラウド,上級,サーバーレスアーキテクチャ
インフラエンジニア,ネットワーク,初級,基本設定（ルーター/スイッチ）
インフラエンジニア,ネットワーク,初級,ネットワークトラブルシュート
インフラエンジニア,ネットワーク,初級,IPアドレス/サブネット設計
インフラエンジニア,ネットワーク,初級,基本的なVPN設定
インフラエンジニア,ネットワーク,中級,ネットワークセキュリティ設計
インフラエンジニア,ネットワーク,中級,負荷分散設計
インフラエンジニア,ネットワーク,中級,SD-WAN導入/運用
インフラエンジニア,ネットワーク,中級,VLAN/仮想ネットワーク設計
インフラエンジニア,ネットワーク,上級,大規模ネットワーク設計
インフラエンジニア,ネットワーク,上級,グローバルネットワーク設計
インフラエンジニア,ネットワーク,上級,クラウド間ネットワーク連携
インフラエンジニア,ネットワーク,上級,次世代ネットワークアーキテクチャ
開発エンジニア（プログラマー）,プログラミング,初級,基本コーディング（1〜2言語）
開発エンジニア（プログラマー）,プログラミング,初級,基本的なアルゴリズム知識
開発エンジニア（プログラマー）,プログラミング,初級,バグ修正/リファクタリング
開発エンジニア（プログラマー）,プログラミング,初級,コードレビュー対応
開発エンジニア（プログラマー）,プログラミング,中級,複数言語でのコーディング
開発エンジニア（プログラマー）,プログラミング,中級,設計パターンの実装
開発エンジニア（プログラマー）,プログラミング,中級,パフォーマンス改善
開発エンジニア（プログラマー）,プログラミング,中級,ライブラリ/フレームワーク活用
開発エンジニア（プログラマー）,プログラミング,上級,技術選定/評価
開発エンジニア（プログラマー）,プログラミング,上級,開発標準の策定
開発エンジニア（プログラマー）,プログラミング,上級,コーディング指導/レビュー
開発エンジニア（プログラマー）,フロントエンド,初級,HTML/CSS基礎（解析/修正）
開発エンジニア（プログラマー）,フロントエンド,初級,JavaScript基礎（Ajax）
開発エンジニア（プログラマー）,フロントエンド,初級,基本的なUIコンポーネント実装
開発エンジニア（プログラマー）,フロントエンド,初級,レスポンシブデザイン基礎
開発エンジニア（プログラマー）,フロントエンド,中級,React/Vue/Angular等の活用
開発エンジニア（プログラマー）,フロントエンド,中級,状態管理（Redux等）
開発エンジニア（プログラマー）,フロントエンド,中級,SPA開発
開発エンジニア（プログラマー）,フロントエンド,中級,UIパフォーマンス最適化
開発エンジニア（プログラマー）,フロントエンド,上級,フロントエンドアーキテクチャ設計
開発エンジニア（プログラマー）,フロントエンド,上級,マイクロフロントエンド設計
開発エンジニア（プログラマー）,フロントエンド,上級,パフォーマンス/アクセシビリティ最適化
開発エンジニア（プログラマー）,フロントエンド,上級,大規模フロントエンド開発管理
開発エンジニア（プログラマー）,バックエンド,初級,基本的なAPI実装
開発エンジニア（プログラマー）,バックエンド,初級,CRUD操作
開発エンジニア（プログラマー）,バックエンド,初級,基本的なデータ処理
開発エンジニア（プログラマー）,バックエンド,初級,シンプルなバックエンド構築
開発エンジニア（プログラマー）,バックエンド,中級,RESTful API設計
開発エンジニア（プログラマー）,バックエンド,中級,セキュアなバックエンド設計
開発エンジニア（プログラマー）,バックエンド,中級,キャッシュ戦略
開発エンジニア（プログラマー）,バックエンド,中級,マイクロサービス基礎
開発エンジニア（プログラマー）,バックエンド,上級,大規模バックエンドアーキテクチャ
開発エンジニア（プログラマー）,バックエンド,上級,マイクロサービス設計
開発エンジニア（プログラマー）,バックエンド,上級,負荷分散/スケーラビリティ設計
開発エンジニア（プログラマー）,バックエンド,上級,API設計標準化
開発エンジニア（SE）,設計,初級,詳細設計書作成
開発エンジニア（SE）,設計,初級,テスト仕様書作成（〜結合）
開発エンジニア（SE）,設計,初級,要件定義支援
開発エンジニア（SE）,設計,中級,基本設計書作成
開発エンジニア（SE）,設計,中級,DB設計/データモデリング
開発エンジニア（SE）,設計,中級,統合テスト設計
開発エンジニア（SE）,設計,中級,要件定義レビュー主導
開発エンジニア（SE）,設計,上級,システム全体設計
開発エンジニア（SE）,設計,上級,大規模システム設計
開発エンジニア（SE）,設計,上級,全体最適化設計
開発エンジニア（SE）,設計,上級,要件定義からの上流工程主導
開発エンジニア（SE）,データベース,初級,基本CRUD操作
開発エンジニア（SE）,データベース,初級,簡易クエリ作成
開発エンジニア（SE）,データベース,初級,テーブル設計基礎
開発エンジニア（SE）,データベース,初級,基本的なSQL最適化
開発エンジニア（SE）,データベース,中級,DB設計/正規化
開発エンジニア（SE）,データベース,中級,パフォーマンスチューニング
開発エンジニア（SE）,データベース,中級,NoSQL基礎
開発エンジニア（SE）,データベース,中級,ETL処理設計
開発エンジニア（SE）,データベース,上級,大規模DB設計
開発エンジニア（SE）,データベース,上級,分散DB設計
開発エンジニア（SE）,データベース,上級,データウェアハウス設計
開発エンジニア（SE）,データベース,上級,高度なリレーショナル/NoSQL構成
開発エンジニア（SE）,開発プロセス,初級,基本テスト実施
開発エンジニア（SE）,開発プロセス,初級,バージョン管理基礎
開発エンジニア（SE）,開発プロセス,初級,ウォーターフォール開発参加
開発エンジニア（SE）,開発プロセス,初級,アジャイル開発参加
開発エンジニア（SE）,開発プロセス,中級,CI/CD構築
開発エンジニア（SE）,開発プロセス,中級,テスト自動化
開発エンジニア（SE）,開発プロセス,中級,アジャイル開発推進
開発エンジニア（SE）,開発プロセス,中級,品質管理プロセス整備
開発エンジニア（SE）,開発プロセス,上級,開発プロセス改善
開発エンジニア（SE）,開発プロセス,上級,DevOps文化構築
開発エンジニア（SE）,開発プロセス,上級,品質保証体制整備
開発エンジニア（SE）,開発プロセス,上級,アジャイルスクラムマスター
開発エンジニア（SE）,セキュリティ,初級,基本的なセキュリティ対策
開発エンジニア（SE）,セキュリティ,初級,脆弱性対応
開発エンジニア（SE）,セキュリティ,初級,認証/認可の基本実装
開発エンジニア（SE）,セキュリティ,初級,セキュアコーディング基礎
開発エンジニア（SE）,セキュリティ,中級,セキュリティ設計
開発エンジニア（SE）,セキュリティ,中級,脆弱性診断/対策
開発エンジニア（SE）,セキュリティ,中級,OAuth/OIDC実装
開発エンジニア（SE）,セキュリティ,中級,セキュリティレビュー実施
開発エンジニア（SE）,セキュリティ,上級,セキュリティ基盤設計
開発エンジニア（SE）,セキュリティ,上級,セキュリティポリシー策定
開発エンジニア（SE）,セキュリティ,上級,セキュリティインシデント対応
開発エンジニア（SE）,セキュリティ,上級,ゼロトラスト設計
マネジメント,マネジメント,初級,小規模チーム管理（〜5人）
マネジメント,マネジメント,初級,タスク配分/進捗管理
マネジメント,マネジメント,初級,チーム内調整
マネジメント,マネジメント,初級,顧客折衝基礎
マネジメント,マネジメント,初級,小規模予算管理
マネジメント,マネジメント,中級,中規模プロジェクト管理
マネジメント,マネジメント,中級,リスク管理
マネジメント,マネジメント,中級,ステークホルダー管理
マネジメント,マネジメント,中級,顧客折衝
マネジメント,マネジメント,中級,予算/工数管理
マネジメント,マネジメント,上級,複数プロジェクト統括
マネジメント,マネジメント,上級,プロジェクト間調整
マネジメント,マネジメント,上級,事業戦略策定
マネジメント,マネジメント,上級,組織マネジメント
マネジメント,マネジメント,上級,経営層とのコミュニケーション`;

    // CSVを手動でパースする（csv-parseパッケージの代わりに）
    const lines = fileContent.split("\n");
    const headers = lines[0].split(",");

    const records = [];
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (line) {
        const values = line.split(",");
        const record: any = {};

        headers.forEach((header, index) => {
          record[header] = values[index];
        });

        records.push(record);
      }
    }

    // 各レコードにIDを付与する
    return records.map((record: any, index: number) => ({
      ...record,
      id: index + 1,
    }));
  } catch (error) {
    console.error("CSVファイルの読み込みに失敗しました:", error);
    return [];
  }
};

/**
 * スキルデータから一意のカテゴリー（分野と項目の組み合わせ）を抽出する関数
 * @param skills スキルデータの配列
 * @returns カテゴリーの配列
 */
export const extractCategories = (skills: Skill[]) => {
  const categories = new Map<string, Set<string>>();

  skills.forEach((skill) => {
    if (!categories.has(skill.分野)) {
      categories.set(skill.分野, new Set());
    }
    categories.get(skill.分野)?.add(skill.項目);
  });

  return Array.from(categories).map(([category, items]) => ({
    category,
    items: Array.from(items),
  }));
};

/**
 * スキルデータを分野ごとにグループ化する関数
 * @param skills スキルデータの配列
 * @returns 分野ごとにグループ化されたスキルデータ
 */
export const groupSkillsByField = (skills: Skill[]) => {
  const grouped = new Map<string, Skill[]>();

  skills.forEach((skill) => {
    if (!grouped.has(skill.分野)) {
      grouped.set(skill.分野, []);
    }
    grouped.get(skill.分野)?.push(skill);
  });

  return grouped;
};

/**
 * スキルデータを分野と項目でグループ化する関数
 * @param skills スキルデータの配列
 * @returns 分野と項目でグループ化されたスキルデータ
 */
export const groupSkillsByCategoryAndItem = (skills: Skill[]) => {
  const grouped = new Map<string, Map<string, Skill[]>>();

  skills.forEach((skill) => {
    if (!grouped.has(skill.分野)) {
      grouped.set(skill.分野, new Map());
    }

    const categoryMap = grouped.get(skill.分野);
    if (!categoryMap?.has(skill.項目)) {
      categoryMap?.set(skill.項目, []);
    }

    categoryMap?.get(skill.項目)?.push(skill);
  });

  return grouped;
};
